<section class="chat">
  <div class="chat-header">
    <div class="user-wrapper">
      <img
        ngSrc="{{ selectedUser.profilePicture }}"
        alt="{{ selectedUser.userName }}"
        width="60"
        height="60"
      />
      <h1>
        <a [routerLink]="['/user', selectedUser.userName]">
          {{ "@" }}{{ selectedUser.userName }}
        </a>
      </h1>
      <p>Last seen {{ selectedUser.lastLogin | dateAgo }}</p>
    </div>
    <ng-icon class="vertical-ellipsis" name="ionEllipsisVerticalSharp" />
  </div>
  <div class="messages-wrapper">
    <div class="chat-users">
      @for (user of recentChats; track user?.id) { @if (user !== undefined) {
      <div class="profile-pic-wrapper">
        @if (user.unreadMessages > 0) {
        <div class="notification-dot">{{ user.unreadMessages }}</div>
        }
        <img
          ngSrc="{{ user?.profilePicture }}"
          alt="{{ user?.userName }}"
          width="60"
          height="60"
          [style]="{
            'box-shadow':
              selectedUser.id == user?.id
                ? '0 0 10px 1px rgba(0, 0, 0, 0.2)'
                : 'none'
          }"
          (click)="selectConversation(user)"
        />
      </div>
      } }
      <ng-icon class="add-user" name="ionAddCircleSharp" />
    </div>
    <div class="messages">
      @if((currentUser$ | async); as user) {
      <div
        class="chat-area"
        #chatArea
        (click)="clearNotificationForUser(selectedUser.id)"
      >
        <p style="text-align: center" #loadMore>&middot;</p>
        @for (message of selectedConversation; track message.id) {
        <div
          class="message"
          [style]="{
            'align-self':
              message.senderId == user.id ? 'flex-end' : 'flex-start'
          }"
        >
          <p>{{ message.content }}</p>
        </div>
        } @empty {
        <!-- TODO: Fix @empty causes flicker while loading conversation -->
        <div class="no-messages">
          <p>
            Your chat with
            <span>{{ selectedUser.userName }}</span>
            it's empty. Say hi!
          </p>
        </div>
        }
      </div>
      <div class="write-msg">
        <img
          ngSrc="{{ user.profilePicture }}"
          alt="{{ user.userName }}"
          width="50"
          height="50"
        />
        <div class="textarea-container">
          <textarea
            [(ngModel)]="message"
            #textarea
            (input)="textareaChange()"
            maxlength="255"
            placeholder="Write a message..."
            (click)="clearNotificationForUser(selectedUser.id)"
          ></textarea>
          @if (message.length > 0) {
          <ng-icon
            class="send-icon-blue"
            name="ionSend"
            (click)="sendMessage()"
          />
          } @else {
          <ng-icon class="send-icon" name="ionSendOutline" />
          }
        </div>
      </div>
      }
    </div>
  </div>
</section>
